# Инструкция по сборке и запуску u-boot для микросхем ЗАО НТЦ "Модуль". 

## Общая информация

Инструкции, представленные ниже тестировались на Debian 10.x и 11.1. Работоспособность на других дистрибутивах Linux, macOS или Windows не гарантируется.

Для начала работы необходимо убедиться, что в системе установлен минимально необходимый набор ПО для разработки. Это можно сделать этой командой:

```
sudo apt install build-essential
```

Далее необходимо убедиться, что в системе установлен интерпретатор языка python версии не ниже 3.7, и pip (В Debian 11 по умолчанию присутствует нужная версия). 

Теперь необходимо установить инструменты для взаимодействия с начальным загрузчиком микросхем (rumboot-tools). Это можно сделать используя pip:

```
pip install rumboot-tools
```

ВАЖНО: При установке rumboot-tools на Windows через pip, необходимы Visual Studio Build Tools. 

На странице релизов на github автоматически формируется набор бинарных пакетов (wheels) для каждой из версий отгруженных в pip. Их установка не требует Visual Studio Build Tools.

Самую свежую версию можно установить с github по ссылке: https://github.com/RC-MODULE/rumboot-tools

ВАЖНО: Версии в pip и на странице релизов загружаются после прохождения набора тестов. Версии в master ветке могут содержать ошибки, не до конца реализованный функционал. Установка из master ветки должна проводиться только по явной просьбе от поддержки, либо в случае если Вы хотите помочь нам с тестированием. (Ну или просто ищите приключений ;) ) 

## 1888ТХ018 (mm7705)

### Тулчейн

Для сборки необходим кросс-компилятор. Можно использовать из репозиториев Debian: 

```
sudo apt install crossbuild-essential-powerpc
```

### Конфигурация

Конфигурация по умолчанию находится в файле configs/mb115-01_defconfig. Скопируйте ее в .config.

```
cp configs/mb115-01_defconfig .config
```

Интерактивное редактирование конфигурации выполняется командой:

```
ARCH=powerpc CROSS_COMPILE=powerpc-linux-gnu- make menuconfig
```

Это обновит значения в файле .config. Сохраните его, чтобы не потерять изменения, если они важны.

### Сборка

Команды сборки будут выглядеть следующим образом

```
ARCH=powerpc CROSS_COMPILE=powerpc-linux-gnu- make
```

В результате получится два файла:
* spl/u-boot-spl-dtb.rbi - u-boot spl
* u-boot.img - u-boot

### Скорость UART

Загрузчик использует скорость 1000000 baud 8 бит данных. нет четности. Инструментальная плата МВ115.01 содержит встроенный преобразователь USB-to-UART (pl2303), выведенный на разъем X15.

ВАЖНО: Не забудьте отключить в настройках Вашей терминальной программы программный и аппаратный контроль четности. 

Напряжение логической "1" - 3.3 вольта. 

ВАЖНО: Не подключайте вывод UART микросхемы напрямую к порту RS232 компьютера. RS232 имеет напряжения логических уровней +12в/-12в. Это сожгет микросхему. 

### Особенности

DDR память инициализируется в u-boot SPL. Параметры берутся из SPD. 

WARNING: Поддерживается только память с 1 ранком. 

### Запуск u-boot из оперативной памяти

```
```

### Прошивка u-boot в SPI Flash

### Прошивка u-boot на SD 

## 1888ВС048 (basis)

### Тулчейн

Для сборки необходим кросс-компилятор. Можно использовать из репозиториев Debian: 

```
sudo apt install crossbuild-essential-armhf
```

### Конфигурация

Конфигурация по умолчанию находится в файле configs/mt143-05_defconfig. Скопируйте ее в .config.

```
cp configs/mt143-05_defconfig .config
```

Интерактивное редактирование конфигурации выполняется командой:

```
ARCH=powerpc CROSS_COMPILE=arm-linux-gnueabihf- make menuconfig
```

Это обновит значения в файле .config. Сохраните его, чтобы не потерять изменения, если они важны.

### Сборка

Команды сборки будут выглядеть следующим образом

```
ARCH=powerpc CROSS_COMPILE=arm-linux-gnueabihf- make
```

В результате получится два файла:
* spl/u-boot-spl-dtb.rbi - u-boot spl
* u-boot.img - u-boot

### Скорость UART

Загрузчик имеет возможность выбора между скоростью 115200 и 6500000 baud при помощи установки вывода GPIO0[2]. Эта скорость должна совпадать с заданной в конфигурации u-boot. По умолчанию в конфигурационном файле используется скорость 115200. Это можно поменять отредактировав параметр CONFIG_BAUDRATE и переставив перемычку в соответствующее состояние.

Используется 8 бит данных, нет четности. Инструментальная плата МТ143.05 содержит встроенный преобразователь USB-to-UART (pl2303), выведенный на разъем X10.

ВАЖНО: Не забудьте отключить в настройках Вашей терминальной программы программный и аппаратный контроль четности. 

Напряжение логической "1" - 3.3 вольта. 

ВАЖНО: Не подключайте вывод UART микросхемы напрямую к порту RS232 компьютера. RS232 имеет напряжения логических уровней +12в/-12в. Это сожгет микросхему. 

### Особенности

DDR память инициализируется отдельным приложением, которое должно быть исполнено ДО того, как будет выполнен u-boot-spl. 

Репозиторий со сценарием для генерации образа конфигуратора представлен по ссылке. 
https://github.com/RC-MODULE/soc_config_tool

После сборки по инструкции должен получится файл ddr_init.bin, выполняющий инициализацию памяти идущей в комплекте с инструментальной платой. 

ВАЖНО: Последовательность инициализации DDR будет дорабатываться ближайшее время, для упрощения поддержки других памятей пользователем и эта инструкция может измениться.

### Запуск u-boot из оперативной памяти

Этот сценарий полезен для отладки u-boot без прошивки в ПЗУ. Флаг `-I` включает интерактивный режим, флаг `-r pl2303` использует для автоматического сброса питания платы механизм gpio линий pl2303 (присутствует на инструментальных платах).

```
rumboot-xrun -f ddr_init.bin -f spl/u-boot-spl-dtb.rbi -f u-boot.img -r pl2303 -p /dev/ttyUSB0 -I
```

### Прошивка u-boot в SPI Flash

#### Скомбинируйте процедуру инициализации DDR и u-boot SPL в один бинарный файл. 

Для SPI Flash используется кратное 1 байту (`-a basic`)

```
rumboot-combine -a basic -i ddr_init.bin -i spl/u-boot-spl-dtb.rbi -i u-boot-dtb.img -o full_loader.bin
```

#### Запишите полученный бинарный файл на SD карту. 

### Прошивка u-boot на SD 

#### Отформатируйте SD карту с таблицой разделов MBR (DOS). 

Необходимо создать два раздела: 

Первый раздел размером 1MB c типом 0xdf - тут будет хранится u-boot.img. Его необходимо сделать "активным"

Второй раздел будет служить для операционной системы. Его можно отформатировать в ext4, или записать в него образ файловой системы, созданный skyforge или multistrap.

#### Скомбинируйте процедуру инициализации DDR и u-boot SPL в один бинарный файл. 

Для этого используется выравнивание для SD карты (опция -a):

```
rumboot-combine -a SD -i ddr_init.bin -i spl/u-boot-spl-dtb.rbi -i u-boot-dtb.img -o full_loader.bin
```

#### Запишите полученный бинарный файл на SPI Flash. 

_ВАЖНО_: На данный момент в инструменты прошивки нет поддержки работы с таблицей разделов MBR, и они не могут ее формировать, считывать и проверять.

_ВАЖНО_: На данный момент в u-boot есть известный баг, мешающий вычитать основной файл u-boot.img из SPI Flash памяти. Он будет исправлен в дальнейшем. Если для Вашего сценария применения важна загрузка u-boot с SPI Flash - дайте нам знать.

Это можно сделать двумя способами: 

* Через механизм внутрисхемной прошивки (rumboot-xflash):

```
rumboot-xflash -m sf00 -f full_loader.bin -W -p /dev/ttyUSB0 -r pl2303
```

sf00/sf01/sf10/sf11 выбирает CS на котором находится микросхема Flash памяти. 

sf00: SPI Flash @ SPI0 CS GPIO0_5 <<---Присутствует на инструментальной плате МТ143.05 

sf01: SPI Flash @ SPI0 Internal CS 

sf10: SPI Flash @ SPI1 CS GPIO0_6

sf11: SPI Flash @ SPI1 Internal CS 

_ВАЖНО_: bootrom не может самостоятельно загрузиться с памяти sf10 (SPI1 CS GPIO0_6)! 

* Использовать внешний программатор и записать полученный full_loader.bin SPI Flash.

# Приложение. Запись корневой файловой системы на карту памяти.

TODO: ....

_ВАЖНО_: Все данные на карте будут уничтожены

_ВАЖНО_: Не ошибитесь в имени устройства, иначе данные будут уничтожены не там, где это ожидается.
